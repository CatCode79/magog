include_rules

# XXX: These ones are nasty.
: lib/glfw/CMakeLists.txt |> mkdir -p glfw-build/; cd glfw-build/; cmake ../lib/glfw; make; cp src/libglfw3.a ..; cd ..; rm -rf glfw-build/ |> libglfw3.a
: lib/portaudio/configure |> cp -r lib/portaudio pa-build; cd pa-build; ./configure CFLAGS=-fPIC; make; cp ./lib/.libs/libportaudio.a ../; cd ..; rm -rf pa-build |> libportaudio.a

: foreach lib/stb/*.c |> !cc |> %B.o {stb_objs}
: {stb_objs} |> !ar |> libstb.a

# Need to use generated rules to manage Rust's crate output name mangling. Grab
# the outputs into named bins so we can refer to them later as dependencies.
run ./rust-rule.sh lib/cgmath-rs/src/cgmath/lib.rs {libcgmath}
run ./rust-rule.sh lib/glfw-rs/src/lib.rs {libglfw}
run ./rust-rule.sh lib/portaudio-rs/src/portaudio/lib.rs {libpa} \| libportaudio.a
run ./rust-rule.sh lib/rust-opengles/lib.rs {libgles}
run ./rust-rule.sh src/calx/lib.rs {libcalx} \| {libcgmath}
run ./rust-rule.sh src/stb/lib.rs {libstb}
run ./rust-rule.sh src/glutil/lib.rs {libglutil} \| {libstb} {libcalx} {libgles} {libcgmath} {libglfw}

: src/shiny/main.rs | {libcgmath} {libglfw} {libgles} {libstb} {libglutil} libstb.a libglfw3.a |> !rustbin $(GLFW_LINKARGS) |> shiny
: src/synth/main.rs | {libpa} libportaudio.a |> !rustbin $(PA_LINKARGS) |> synth
: src/runtests/main.rs |> !rustbin |> runtests

# Testing. All unit test runners are expected to start with 'test_'.
: src/calx/lib.rs | {libcalx} |> !rustbin --test |> test_calx

: lib/cgmath-rs/src/test/test.rs | {libcgmath} |> !rustbin --test |> test_cgmath
