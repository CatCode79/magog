include_rules

# XXX: These ones are nasty.
: lib/glfw/CMakeLists.txt |> mkdir -p glfw-build/; cd glfw-build/; cmake ../lib/glfw; make; cp src/libglfw3.a ..; cd ..; rm -rf glfw-build/ |> libglfw3.a
: lib/portaudio/configure |> cp -r lib/portaudio pa-build; cd pa-build; ./configure CFLAGS=-fPIC; make; cp ./lib/.libs/libportaudio.a ../; cd ..; rm -rf pa-build |> libportaudio.a

: foreach lib/stb/*.c |> !cc |> %B.o {stb_objs}
: {stb_objs} |> !ar |> libstb.a

# Code generation.
# XXX: Tup doesn't seem to add files generated under src/ dir in .gitignore.
: assets/pf_tempesta_seven_extended_bold.ttf |> !databake |> gen/font_data.rs

# Need to use generated rules to manage Rust's crate output name mangling. Grab
# the outputs into named bins so we can refer to them later as dependencies.
run ./rust-rule.sh lib/cgmath-rs/src/cgmath/lib.rs {libcgmath}
run ./rust-rule.sh lib/glfw-rs/src/lib/lib.rs {libglfw}
run ./rust-rule.sh lib/portaudio-rs/src/portaudio/lib.rs {libpa} \| libportaudio.a
run ./rust-rule.sh lib/gl-rs/src/gl/lib.rs {libgl}
run ./rust-rule.sh lib/color-rs/src/lib.rs {libcolor}
run ./rust-rule.sh lib/hgl-rs/lib.rs {libhgl} \| {libgl}
run ./rust-rule.sh src/calx/lib.rs {libcalx} \| {libcgmath}
run ./rust-rule.sh src/stb/lib.rs {libstb}
run ./rust-rule.sh src/glutil/lib.rs {libglutil} \| {libstb} {libcalx} {libgl} {libhgl} {libcolor} {libcgmath} {libglfw} gen/font_data.rs

: src/shiny/main.rs | {libcgmath} {libglfw} {libgl} {libstb} {libglutil} libstb.a libglfw3.a |> !rustbin $(GLFW_LINKARGS) |> shiny
: src/roamy/main.rs | {libcgmath} {libglfw} {libgl} {libstb} {libglutil} libstb.a libglfw3.a |> !rustbin $(GLFW_LINKARGS) |> roamy
: src/synth/main.rs | {libpa} libportaudio.a |> !rustbin $(PA_LINKARGS) |> synth
: src/runtests/main.rs |> !rustbin |> runtests

# Testing. All unit test runners are expected to start with 'test_'.
: src/calx/lib.rs | {libcalx} |> !rustbin --test |> test_calx
: src/test/test_glfill.rs | {libcgmath} {libglutil} {libcalx} libglfw3.a libstb.a |> !rustbin --test $(GLFW_LINKARGS) |> test_glfill

: lib/cgmath-rs/src/test/test.rs | {libcgmath} |> !rustbin --test |> test_cgmath
